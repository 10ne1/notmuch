#! /bin/sh

cat <<EOF
Welcome to Notmuch, a system for indexing, searching and tagging your email.

We hope that the process of building and installing notmuch is quick
and smooth so that you can soon be reading and processing your email
more efficiently than ever.

If anything goes wrong in the configure process, you can override any
decisions it makes by manually editing the Makefile.config file that
it creates. Also please do as much as you can to figure out what could
be different on your machine compared to those of the notmuch
developers. Then, please email those details to the Notmuch list
(notmuch@notmuchmail.org) so that we can hopefully make future
versions of notmuch easier for you to use.

We'll now investigate your system to verify that all required
dependencies are available:

EOF

errors=0

if pkg-config --version > /dev/null 2>&1; then
    have_pkg_config=1
else
    have_pkg_config=0
fi

printf "Checking for Xapian development files... "
if xapian-config --version > /dev/null 2>&1; then
    printf "Yes.\n"
    have_xapian=1
    cxxflags="${cxxflags} $(xapian-config --cxxflags)"
    ldflags="${ldflags} $(xapian-config --libs)"
else
    printf "No.\n"
    have_xapian=0
    errors=$((errors + 1))
fi

printf "Checking for GMime 2.4 development files... "
if pkg-config --modversion gmime-2.4 > /dev/null 2>&1; then
    printf "Yes.\n"
    have_gmime=1
    cflags="${cflags} $(pkg-config --cflags gmime-2.4)"
    ldflags="${ldflags} $(pkg-config --libs gmime-2.4)"
else
    printf "No.\n"
    have_gmime=0
    errors=$((errors + 1))
fi

printf "Checking for talloc development files... "
if pkg-config --modversion talloc > /dev/null 2>&1; then
    printf "Yes.\n"
    have_talloc=1
    cflags="${cflags} $(pkg-config --cflags talloc)"
    ldflags="${ldflags} $(pkg-config --libs talloc)"
else
    printf "No.\n"
    have_talloc=0
    talloc_cflags=
    errors=$((errors + 1))
fi

printf "Checking for valgrind development files... "
if pkg-config --modversion valgrind > /dev/null 2>&1; then
    printf "Yes.\n"
    have_valgrind=1
    cflags="${cflags} $(pkg-config --cflags valgrind)"
else
    printf "No (but that's fine).\n"
    have_valgrind=0
fi

if pkg-config --modversion emacs > /dev/null 2>&1; then
    emacs_lispdir=$(pkg-config emacs --variable sitepkglispdir)
else
    emacs_lispdir='$(prefix)/share/emacs/site-lisp'
fi

if [ $errors -gt 0 ]; then
    cat <<EOF

*** Error: The dependencies of notmuch could not be satisfied. You will
need to install the following packages before being able to compile
notmuch:

EOF
    if [ $have_xapian -eq 0 ]; then
	echo "	Xapian library (including development files such as headers)"
	echo "	http://xapian.org/"
    fi
    if [ $have_gmime -eq 0 ]; then
	echo "	GMime 2.4 library (including development files such as headers)"
	echo "	http://spruce.sourceforge.net/gmime/"
    fi
    if [ $have_talloc -eq 0 ]; then
	echo "	The talloc library (including development files such as headers)"
	echo "	http://talloc.samba.org/"
    fi
    cat <<EOF

On a modern, package-based operating system such as Debian, you can
install all of the dependencies with the following simple command
line:

	sudo apt-get install libxapian-dev libgmime-2.4-dev libtalloc-dev

On other systems, a similar command can be used, but the details of the 
package names may be different, (such as "devel" in place of "dev").

EOF
    if [ $have_pkg_config -eq 0 ]; then
cat <<EOF
Note: the pkg-config program is not available. This configure script
uses pkg-config to find the compilation flags required to link against
the various libraries needed by notmuch. It's possible you simply need
to install pkg-config with a command such as:

	sudo apt-get install pkg-config

But if pkg-config is not available for your system, then you will need
to modify the configure script to manually set the cflags and ldflags
variables to the correct values to link against each library in each
case that pkg-config could not be used to determine those values.

EOF
    fi
cat <<EOF
When you have installed the necessary dependencies, you can run
configure again to ensure the packages can be found, or simply run
"make" to compile notmuch.

EOF
    exit 1
fi

printf "Checking for getline... "
if gcc -o config/have_getline config/have_getline.c > /dev/null 2>&1
then
    printf "Yes.\n"
    have_getline=1
else
    printf "No (will use our own instead).\n"
    have_getline=0
fi
rm -f config/have_getline

cat <<EOF

All required packages were found. You may now run the following
commands to compile and install notmuch:

	make
	sudo make install

EOF

# construct the Makefile.config
cat > Makefile.config <<EOF
# This Makefile.config was automatically generated by the ./configure
# script of notmuch. If the configure script identified anything
# incorrectly, then you can edit this file to try to correct things,
# but be warned that if configure is run again it will destroy your
# changes, (and this could happen by simply calling "make" if the
# configure script is updated).

# The prefix to which notmuch should be installed
prefix = /usr/local

# The directory to which emacs lisp files should be installed
emacs_lispdir=${emacs_lispdir}

# Whether the getline function is available (if not, then notmuch will
# build its own version)
HAVE_GETLINE = ${have_getline}

# Various flags needed to compile and link against the dependencies of
# notmuch.
override CFLAGS += ${cflags} -DHAVE_VALGRIND=${have_valgrind} -DHAVE_GETLINE=\$(HAVE_GETLINE)
override CXXFLAGS += ${cflags} ${cxxflags}
override LDFLAGS += ${ldflags}
EOF
